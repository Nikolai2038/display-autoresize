#!/bin/bash

# Fail command if any of pipeline blocks fail
set -o pipefail || exit "$?"

log_file_path="/var/log/display-autoresize.log"

# Only run as root user
if [ "${EUID}" -ne 0 ]; then
    echo "Please run as root." >&2
    exit 1
fi

# Function to find User Sessions & Resize their display
function display_autoresize() {
    declare -A users displays
    local user_online user display session_user session_display session_output

    for user_online in $(users); do
        # skip root
        if [ "${user_online}" = root ]; then
            continue
        fi
        users["${user_online}"]=1
    done

    for user_online in "${!users[@]}"; do
        for user in $(ps e -u "${user_online}" | sed -rn 's/.* DISPLAY=(:[0-9]*).*/\1/p');do
            displays["${user}"]="${user_online}"
        done
    done

    for display in "${!displays[@]}";do
	    session_user="${displays["${display}"]}"
	    session_display="${display}"
	    session_output=$(su - "${session_user}" -c "PATH=/usr/bin DISPLAY=\"${session_display}\" xrandr | awk '/ connected/{print \$1; exit; }'") || return "$?"

      # shellcheck disable=SC2320
      echo "Resize event: $(date +'%Y-%m-%d_%H-%M-%S'):
- Session User: ${session_user}
- Session Display: ${session_display}
- Session Output: ${session_output}" >&2 || return "$?"

	    su - "${session_user}" -c "PATH=/usr/bin DISPLAY=\"${session_display}\" xrandr --output \"${session_output}\" --auto" || return "$?"
    done
}

display_autoresize "$@" 2>&1 | tee -a "${log_file_path}" || exit "$?"
